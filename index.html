import React, { useState } from 'react';
import { Upload, Download, FileSpreadsheet, CheckCircle, AlertCircle, Code, Sparkles } from 'lucide-react';
import * as XLSX from 'xlsx';

const GLTrialBalanceTool = () => {
  const [file, setFile] = useState(null);
  const [glData, setGlData] = useState([]);
  const [trialBalance, setTrialBalance] = useState([]);
  const [errors, setErrors] = useState([]);
  const [showFormulas, setShowFormulas] = useState(false);
  const [processing, setProcessing] = useState(false);

  // Standard accounting rules
  const accountRules = {
    'Cash': { type: 'Asset', normalBalance: 'Debit', debit: 'increase', credit: 'decrease' },
    'Inventory': { type: 'Asset', normalBalance: 'Debit', debit: 'increase', credit: 'decrease' },
    'Accounts Receivable': { type: 'Asset', normalBalance: 'Debit', debit: 'increase', credit: 'decrease' },
    'Equipment': { type: 'Asset', normalBalance: 'Debit', debit: 'increase', credit: 'decrease' },
    'Accounts Payable': { type: 'Liability', normalBalance: 'Credit', debit: 'decrease', credit: 'increase' },
    'AP': { type: 'Liability', normalBalance: 'Credit', debit: 'decrease', credit: 'increase' },
    'Notes Payable': { type: 'Liability', normalBalance: 'Credit', debit: 'decrease', credit: 'increase' },
    'Owner\'s Investment': { type: 'Equity', normalBalance: 'Credit', debit: 'decrease', credit: 'increase' },
    'Owner\'s Capital': { type: 'Equity', normalBalance: 'Credit', debit: 'decrease', credit: 'increase' },
    'Revenue': { type: 'Revenue', normalBalance: 'Credit', debit: 'decrease', credit: 'increase' },
    'Sales': { type: 'Revenue', normalBalance: 'Credit', debit: 'decrease', credit: 'increase' },
    'Expenses': { type: 'Expense', normalBalance: 'Debit', debit: 'increase', credit: 'decrease' },
    'Rent Expense': { type: 'Expense', normalBalance: 'Debit', debit: 'increase', credit: 'decrease' },
    'Salary Expense': { type: 'Expense', normalBalance: 'Debit', debit: 'increase', credit: 'decrease' },
  };

  const detectAccountType = (accountName) => {
    const normalized = accountName.trim();
    for (let key in accountRules) {
      if (normalized.toLowerCase().includes(key.toLowerCase())) {
        return accountRules[key];
      }
    }
    return null;
  };

  const handleFileUpload = async (e) => {
    const uploadedFile = e.target.files[0];
    if (!uploadedFile) return;

    setFile(uploadedFile);
    setProcessing(true);

    try {
      const data = await uploadedFile.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

      processGLData(jsonData);
    } catch (error) {
      console.error('Error processing file:', error);
      alert('Error processing file. Please ensure it\'s a valid Excel/CSV file.');
    }

    setProcessing(false);
  };

  const processGLData = (rawData) => {
    const foundErrors = [];
    const accounts = {};
    
    // Parse the data
    let headerRow = -1;
    for (let i = 0; i < rawData.length; i++) {
      const row = rawData[i];
      if (row.some(cell => cell && cell.toString().toLowerCase().includes('account'))) {
        headerRow = i;
        break;
      }
    }

    if (headerRow === -1) {
      alert('Could not find header row with account names');
      return;
    }

    const headers = rawData[headerRow];
    
    // Process each account column
    for (let col = 0; col < headers.length; col++) {
      const accountName = headers[col];
      if (!accountName || accountName.toString().trim() === '') continue;

      const accountRule = detectAccountType(accountName);
      if (!accountRule) continue;

      // Collect transactions for this account
      const transactions = [];
      for (let row = headerRow + 1; row < rawData.length; row++) {
        const cell = rawData[row][col];
        if (cell && !isNaN(parseFloat(cell))) {
          transactions.push({
            row: row + 1,
            value: parseFloat(cell),
            type: cell > 0 ? 'debit' : 'credit',
            absValue: Math.abs(parseFloat(cell))
          });
        }
      }

      // Check for debit/credit notation errors in header
      const headerText = accountName.toString().toLowerCase();
      const hasDebitPlus = headerText.includes('debit(+)');
      const hasCreditPlus = headerText.includes('credit(+)');
      const hasDebitMinus = headerText.includes('debit(-)');
      const hasCreditMinus = headerText.includes('credit(-)');

      // Validate notation
      if (accountRule.debit === 'increase' && hasDebitMinus) {
        foundErrors.push({
          account: accountName,
          error: `Should be "debit(+)" not "debit(-)" for ${accountRule.type} accounts`,
          correction: `${accountName.replace('debit(-)', 'debit(+')}`,
          severity: 'high'
        });
      }
      if (accountRule.debit === 'decrease' && hasDebitPlus) {
        foundErrors.push({
          account: accountName,
          error: `Should be "debit(-)" not "debit(+)" for ${accountRule.type} accounts`,
          correction: `${accountName.replace('debit(+)', 'debit(-')}`,
          severity: 'high'
        });
      }
      if (accountRule.credit === 'increase' && hasCreditMinus) {
        foundErrors.push({
          account: accountName,
          error: `Should be "credit(+)" not "credit(-)" for ${accountRule.type} accounts`,
          correction: `${accountName.replace('credit(-)', 'credit(+')}`,
          severity: 'high'
        });
      }
      if (accountRule.credit === 'decrease' && hasCreditPlus) {
        foundErrors.push({
          account: accountName,
          error: `Should be "credit(-)" not "credit(+)" for ${accountRule.type} accounts`,
          correction: `${accountName.replace('credit(+)', 'credit(-')}`,
          severity: 'high'
        });
      }

      // Calculate totals
      const debits = transactions.filter(t => t.value > 0).reduce((sum, t) => sum + t.absValue, 0);
      const credits = transactions.filter(t => t.value < 0).reduce((sum, t) => sum + t.absValue, 0);
      
      accounts[accountName] = {
        name: accountName,
        type: accountRule.type,
        normalBalance: accountRule.normalBalance,
        debits,
        credits,
        balance: debits - credits,
        transactions
      };
    }

    setErrors(foundErrors);
    setGlData(Object.values(accounts));
    generateTrialBalance(Object.values(accounts));
  };

  const generateTrialBalance = (accounts) => {
    const tb = accounts.map(acc => {
      const balance = acc.balance;
      return {
        account: acc.name.replace(/\s*credit\([+-]\)|\s*debit\([+-]\)/gi, '').trim(),
        type: acc.type,
        debit: balance > 0 ? Math.abs(balance) : 0,
        credit: balance < 0 ? Math.abs(balance) : 0,
        formula: balance > 0 
          ? `=SUM(Debits) - SUM(Credits)` 
          : `=SUM(Credits) - SUM(Debits)`
      };
    });

    const totalDebits = tb.reduce((sum, item) => sum + item.debit, 0);
    const totalCredits = tb.reduce((sum, item) => sum + item.credit, 0);

    tb.push({
      account: 'TOTAL',
      type: '',
      debit: totalDebits,
      credit: totalCredits,
      formula: '=SUM(Debit Column)'
    });

    setTrialBalance(tb);
  };

  const downloadExcel = () => {
    const wb = XLSX.utils.book_new();

    // Create corrected GL sheet
    const glSheet = [
      ['CORRECTED GENERAL LEDGER'],
      [''],
      ['Account', 'Type', 'Debits', 'Credits', 'Balance', 'Formula Used']
    ];

    glData.forEach(acc => {
      glSheet.push([
        acc.name.replace(/\s*credit\([+-]\)|\s*debit\([+-]\)/gi, '').trim(),
        acc.type,
        acc.debits,
        acc.credits,
        acc.balance,
        '=SUM(Debits) - SUM(Credits)'
      ]);
    });

    // Create Trial Balance sheet
    const tbSheet = [
      ['TRIAL BALANCE'],
      [''],
      ['Account', 'Type', 'Debit', 'Credit', 'Formula']
    ];

    trialBalance.forEach(item => {
      tbSheet.push([
        item.account,
        item.type,
        item.debit || '',
        item.credit || '',
        item.formula
      ]);
    });

    // Create Errors sheet
    const errorSheet = [
      ['ERROR REPORT'],
      [''],
      ['Account', 'Error Found', 'Correction', 'Severity']
    ];

    errors.forEach(err => {
      errorSheet.push([
        err.account,
        err.error,
        err.correction,
        err.severity
      ]);
    });

    // Create Formulas Reference sheet
    const formulaSheet = [
      ['ACCOUNTING FORMULAS REFERENCE'],
      [''],
      ['Purpose', 'Formula', 'Description'],
      ['Account Balance', '=SUM(Debits) - SUM(Credits)', 'Calculate net balance for each account'],
      ['Trial Balance Debit', '=IF(Balance>0, Balance, 0)', 'Show positive balances in debit column'],
      ['Trial Balance Credit', '=IF(Balance<0, ABS(Balance), 0)', 'Show negative balances in credit column'],
      ['Total Debits', '=SUM(Debit_Column)', 'Sum all debit balances'],
      ['Total Credits', '=SUM(Credit_Column)', 'Sum all credit balances'],
      ['Balance Check', '=Total_Debits - Total_Credits', 'Should equal zero if balanced'],
      [''],
      ['ACCOUNT TYPE RULES'],
      ['Type', 'Normal Balance', 'Debit Effect', 'Credit Effect'],
      ['Assets', 'Debit', 'Increase (+)', 'Decrease (-)'],
      ['Liabilities', 'Credit', 'Decrease (-)', 'Increase (+)'],
      ['Equity', 'Credit', 'Decrease (-)', 'Increase (+)'],
      ['Revenue', 'Credit', 'Decrease (-)', 'Increase (+)'],
      ['Expenses', 'Debit', 'Increase (+)', 'Decrease (-)']
    ];

    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(glSheet), 'Corrected GL');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(tbSheet), 'Trial Balance');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(errorSheet), 'Error Report');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(formulaSheet), 'Formulas Reference');

    XLSX.writeFile(wb, 'Corrected_GL_Trial_Balance.xlsx');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="text-center mb-12">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Sparkles className="w-12 h-12 text-yellow-400 animate-pulse" />
            <h1 className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">
              GL Detective Pro
            </h1>
            <Sparkles className="w-12 h-12 text-yellow-400 animate-pulse" />
          </div>
          <p className="text-xl text-gray-300">The Ultimate General Ledger Error Detection & Trial Balance Generator</p>
          <p className="text-sm text-purple-300 mt-2">Upload → Detect → Correct → Download</p>
        </div>

        {/* Upload Section */}
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 mb-8 border border-white/20 shadow-2xl">
          <div className="flex items-center gap-3 mb-6">
            <Upload className="w-8 h-8 text-blue-400" />
            <h2 className="text-2xl font-bold text-white">Upload Your GL File</h2>
          </div>
          
          <div className="border-2 border-dashed border-purple-400 rounded-xl p-12 text-center hover:border-pink-400 transition-all hover:bg-white/5">
            <input
              type="file"
              accept=".xlsx,.xls,.csv"
              onChange={handleFileUpload}
              className="hidden"
              id="file-upload"
            />
            <label htmlFor="file-upload" className="cursor-pointer">
              <FileSpreadsheet className="w-16 h-16 text-purple-400 mx-auto mb-4" />
              <p className="text-xl text-white mb-2">Click to upload or drag & drop</p>
              <p className="text-gray-400">Excel (.xlsx, .xls) or CSV files</p>
            </label>
            {file && (
              <div className="mt-4 text-green-400 font-semibold">
                ✓ {file.name}
              </div>
            )}
          </div>
        </div>

        {/* Processing Indicator */}
        {processing && (
          <div className="bg-blue-500/20 border border-blue-400 rounded-xl p-6 mb-8 text-center">
            <div className="animate-spin w-12 h-12 border-4 border-blue-400 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p className="text-blue-300 text-lg">Analyzing your GL...</p>
          </div>
        )}

        {/* Errors Section */}
        {errors.length > 0 && (
          <div className="bg-red-500/10 backdrop-blur-lg rounded-2xl p-8 mb-8 border border-red-400/50 shadow-2xl">
            <div className="flex items-center gap-3 mb-6">
              <AlertCircle className="w-8 h-8 text-red-400" />
              <h2 className="text-2xl font-bold text-white">Errors Detected: {errors.length}</h2>
            </div>
            <div className="space-y-4">
              {errors.map((err, idx) => (
                <div key={idx} className="bg-black/30 rounded-lg p-4 border border-red-400/30">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <p className="text-red-300 font-semibold text-lg mb-2">Account: {err.account}</p>
                      <p className="text-gray-300 mb-2">❌ {err.error}</p>
                      <p className="text-green-400">✓ Correction: {err.correction}</p>
                    </div>
                    <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                      err.severity === 'high' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-black'
                    }`}>
                      {err.severity.toUpperCase()}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Trial Balance Section */}
        {trialBalance.length > 0 && (
          <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 mb-8 border border-white/20 shadow-2xl">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <CheckCircle className="w-8 h-8 text-green-400" />
                <h2 className="text-2xl font-bold text-white">Trial Balance</h2>
              </div>
              <button
                onClick={() => setShowFormulas(!showFormulas)}
                className="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all"
              >
                <Code className="w-5 h-5" />
                {showFormulas ? 'Hide Formulas' : 'Show Formulas'}
              </button>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full text-left">
                <thead>
                  <tr className="border-b-2 border-purple-400">
                    <th className="py-3 px-4 text-purple-300 font-bold">Account</th>
                    <th className="py-3 px-4 text-purple-300 font-bold">Type</th>
                    <th className="py-3 px-4 text-purple-300 font-bold text-right">Debit</th>
                    <th className="py-3 px-4 text-purple-300 font-bold text-right">Credit</th>
                    {showFormulas && <th className="py-3 px-4 text-purple-300 font-bold">Formula</th>}
                  </tr>
                </thead>
                <tbody>
                  {trialBalance.map((item, idx) => (
                    <tr key={idx} className={`border-b border-white/10 ${
                      item.account === 'TOTAL' ? 'bg-purple-500/20 font-bold text-lg' : 'hover:bg-white/5'
                    }`}>
                      <td className="py-3 px-4 text-white">{item.account}</td>
                      <td className="py-3 px-4 text-gray-300">{item.type}</td>
                      <td className="py-3 px-4 text-right text-green-400">
                        {item.debit > 0 ? item.debit.toFixed(2) : '-'}
                      </td>
                      <td className="py-3 px-4 text-right text-blue-400">
                        {item.credit > 0 ? item.credit.toFixed(2) : '-'}
                      </td>
                      {showFormulas && (
                        <td className="py-3 px-4 text-yellow-300 font-mono text-sm">{item.formula}</td>
                      )}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Balance Check */}
            <div className="mt-6 p-4 bg-black/30 rounded-lg border border-green-400/50">
              {Math.abs(trialBalance[trialBalance.length - 1].debit - trialBalance[trialBalance.length - 1].credit) < 0.01 ? (
                <p className="text-green-400 text-center text-lg font-semibold">
                  ✓ Trial Balance is BALANCED!
                </p>
              ) : (
                <p className="text-red-400 text-center text-lg font-semibold">
                  ⚠ Trial Balance is OUT OF BALANCE by {Math.abs(trialBalance[trialBalance.length - 1].debit - trialBalance[trialBalance.length - 1].credit).toFixed(2)}
                </p>
              )}
            </div>
          </div>
        )}

        {/* Download Section */}
        {trialBalance.length > 0 && (
          <div className="bg-gradient-to-r from-green-500/20 to-blue-500/20 backdrop-blur-lg rounded-2xl p-8 border border-green-400/50 shadow-2xl text-center">
            <h2 className="text-2xl font-bold text-white mb-4">Ready to Download!</h2>
            <p className="text-gray-300 mb-6">Your corrected GL with Trial Balance, Error Report, and Formulas Reference</p>
            <button
              onClick={downloadExcel}
              className="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold text-lg rounded-xl transition-all transform hover:scale-105 shadow-lg"
            >
              <Download className="w-6 h-6" />
              Download Excel File
            </button>
          </div>
        )}

        {/* Formula Reference */}
        {trialBalance.length > 0 && (
          <div className="mt-8 bg-white/5 backdrop-blur-lg rounded-2xl p-8 border border-white/10">
            <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-3">
              <Code className="w-8 h-8 text-yellow-400" />
              Formulas Used in This Tool
            </h2>
            <div className="grid md:grid-cols-2 gap-4">
              <div className="bg-black/30 rounded-lg p-4 border border-purple-400/30">
                <p className="text-purple-300 font-semibold mb-2">Account Balance</p>
                <code className="text-yellow-300 text-sm">= SUM(Debits) - SUM(Credits)</code>
              </div>
              <div className="bg-black/30 rounded-lg p-4 border border-purple-400/30">
                <p className="text-purple-300 font-semibold mb-2">Trial Balance Debit</p>
                <code className="text-yellow-300 text-sm">= IF(Balance &gt; 0, Balance, 0)</code>
              </div>
              <div className="bg-black/30 rounded-lg p-4 border border-purple-400/30">
                <p className="text-purple-300 font-semibold mb-2">Trial Balance Credit</p>
                <code className="text-yellow-300 text-sm">= IF(Balance &lt; 0, ABS(Balance), 0)</code>
              </div>
              <div className="bg-black/30 rounded-lg p-4 border border-purple-400/30">
                <p className="text-purple-300 font-semibold mb-2">Balance Check</p>
                <code className="text-yellow-300 text-sm">= Total_Debits - Total_Credits</code>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default GLTrialBalanceTool;
