<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starweave Tailors - Data Cleaning Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a148c 0%, #6a1b9a 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.95;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 3px solid #4a148c;
        }
        
        .tab {
            flex: 1;
            padding: 18px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
            font-size: 15px;
        }
        
        .tab:hover {
            background: #eeeeee;
        }
        
        .tab.active {
            background: white;
            border-bottom-color: #6a1b9a;
            color: #6a1b9a;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6a1b9a 0%, #4a148c 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(106, 27, 154, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(106, 27, 154, 0.5);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #757575 0%, #616161 100%);
        }
        
        button.export {
            background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
        }
        
        .status {
            flex: 1;
            text-align: right;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        
        .table-container {
            overflow-x: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .table-wrapper {
            max-height: 650px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: linear-gradient(135deg, #6a1b9a 0%, #4a148c 100%);
            color: white;
            padding: 14px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 3px solid #4a148c;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover {
            background: #f8f4ff;
        }
        
        .cell-wrapper {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
            min-width: 60px;
        }
        
        .cell-wrapper:hover {
            background: #e1bee7;
            transform: scale(1.02);
        }
        
        .formula-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #6a1b9a;
            border-radius: 50%;
            margin-left: 4px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .formula-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #6a1b9a;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .formula-display h3 {
            color: #6a1b9a;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cell-ref {
            background: #e1bee7;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .formula {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            word-break: break-all;
            margin-bottom: 15px;
            border-left: 4px solid #6a1b9a;
            line-height: 1.6;
        }
        
        .explanation {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
            background: #fff3e0;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #ff6f00;
        }
        
        .original-value {
            color: #c62828;
            font-weight: 600;
        }
        
        .cleaned-value {
            color: #2e7d32;
            font-weight: 600;
        }
        
        .flag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .flag-corrected {
            background: #c8e6c9;
            color: #2e7d32;
        }
        
        .flag-duplicate {
            background: #ffcdd2;
            color: #c62828;
        }
        
        .flag-warning {
            background: #fff9c4;
            color: #f57f17;
        }
        
        .duplicate {
            background: #ffebee !important;
        }
        
        .corrected {
            background: #e8f5e9 !important;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #6a1b9a 0%, #4a148c 100%);
            color: white;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(106, 27, 154, 0.3);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
        }
        
        .stat-card h3 {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
        }
        
        .issues-section {
            background: #fff3e0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #ff6f00;
        }
        
        .issues-section h3 {
            margin-bottom: 15px;
            color: #e65100;
            font-size: 18px;
        }
        
        .issue-item {
            padding: 12px 16px;
            background: white;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #ff6f00;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .issue-icon {
            font-size: 20px;
        }
        
        .formulas-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .formula-group {
            background: white;
            padding: 18px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #6a1b9a;
        }
        
        .formula-group h4 {
            color: #6a1b9a;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .formula-code {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-bottom: 8px;
            white-space: pre-wrap;
            border: 1px solid #e0e0e0;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 28px;
            color: #999;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® Starweave Tailors - Financial Data Cleaning</h1>
            <p>Interactive Formula-Based Data Cleaning Tool | Click any cleaned cell to view its formula</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('raw')">üìã Raw Data</div>
            <div class="tab" onclick="showTab('cleaned')">‚úÖ Cleaned Data (Formula View)</div>
            <div class="tab" onclick="showTab('analysis')">üìä Data Quality Analysis</div>
            <div class="tab" onclick="showTab('formulas')">üìê All Formulas Reference</div>
        </div>
        
        <div id="raw" class="tab-content active">
            <div class="controls">
                <button onclick="loadRawData()">üîÑ Load Raw Data</button>
                <button class="export" onclick="exportData('raw')">üíæ Export Raw CSV</button>
                <div class="status" id="rawStatus"></div>
            </div>
            <div class="table-container">
                <div class="table-wrapper">
                    <table id="rawTable">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Account Affected</th>
                                <th>Payment Method</th>
                                <th>Vendor/Customer</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="rawTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="cleaned" class="tab-content">
            <div class="controls">
                <button onclick="applyCleaning()">üßπ Apply Cleaning Formulas</button>
                <button class="export" onclick="exportData('cleaned')">üíæ Export Cleaned CSV</button>
                <button class="secondary" onclick="copyFormulasToClipboard()">üìã Copy All Formulas</button>
                <div class="status" id="cleanedStatus"></div>
            </div>
            <div class="table-container">
                <div class="table-wrapper">
                    <table id="cleanedTable">
                        <thead>
                            <tr>
                                <th>Trans_ID</th>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Account</th>
                                <th>Payment_Method</th>
                                <th>Vendor_Customer</th>
                                <th>Notes</th>
                                <th>Quality_Flag</th>
                            </tr>
                        </thead>
                        <tbody id="cleanedTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="analysis" class="tab-content">
            <div class="stats" id="statsContainer"></div>
            <div class="issues-section" id="issuesSection"></div>
        </div>
        
        <div id="formulas" class="tab-content">
            <div class="formulas-section" id="formulasSection"></div>
        </div>
    </div>
    
    <div class="overlay" id="overlay" onclick="hideFormula()"></div>
    <div id="formulaDisplay" class="formula-display" style="display: none;">
        <span class="close-btn" onclick="hideFormula()">√ó</span>
        <h3>
            üìê Formula for Cell <span class="cell-ref" id="cellRef"></span>
        </h3>
        <div class="formula" id="formulaText"></div>
        <div class="explanation" id="formulaExplanation"></div>
    </div>

    <script>
        const rawCSV = `Transaction ID,Date,Description,Amount,Account Affected,Payment Method,Vendor/Customer,Notes
T001,10/1/2025,Sale of Enchanted Evening Cloak,$450,sales revenue,Crystal Card,Lady Thornwick,Custom embroidery requested
T002,10/3/2025,Glamour service - Autumn Ball,275,Service Revenue,,Lord Bramblestone,3-hour duration
T003,10/5/2025,Purchase of moonsilk fabric,$681,supplies expense,Gold Coins,Celestial Weavers Ltd.,
T004,10/7/2025,Sale of Self-Mending Tunic (x3),,SALES REVENUE,Dragon Bank Transfer,The Adventurer's Guild,Bulk discount applied
T005,Oct 8 2025,Rent payment for shop space,"$1,200.00",Rent Expense,Crystal Card,Mystmoor Property Management,Monthly rent - October
T002,10/3/2025,Glamour service - Autumn Ball,275,Service Revenue,Crystal Card,Lord Bramblestone,3-hour duration
T007,10/10/2025,Purchase of thread and needles,$146,supplies expense,gold coins,celestial weavers,Various colors
,10/12/2025,Owner withdrew funds for personal use,$500,Owner Withdrawal,Cash,Moonwhisper Starweave (Owner),Personal expenses
T009,10/14/2025,Glamour consultation service,125,Service Revenue,Gold Coins,Baroness Silverpetal,Trial session before wedding
T010,October 16 2025,,$890.00,Sales Revenue,Dragon Bank Transfer,Captain Ironhelm,Rush order - completed in 2 days
T011,10/18/2025,Utility payment - Enchanted Lighting,$95.00,utilities expense,crystal card,Luminos Magical Services,
T011,10/20/2025,Sale of Temperature-Regulating Scarf,$180.00,Sales revenue,Cash,Merchant Thistledown,
T013,10/22/2025,Purchase of enchanted buttons & clasps,$235,Supplies Expense,Gold Coins,Arcane Notions Supply,Rare phoenix-feather buttons included
T014,10/24/2025,Glamour service - Business meeting,$200.00,Service Revenue,Crystal Card,,Executive glamour - confidence enhancement
T015,10/26/2025,Initial investment by owner,5000,Owner Investment,CASH,Moonwhisper Starweave,Starting capital for business`;

        let rawData = [];
        let cleanedData = [];
        let formulas = {};

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map((line, idx) => {
                const matches = [];
                let inQuotes = false;
                let current = '';
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        matches.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                matches.push(current.trim());
                
                const row = {};
                headers.forEach((header, i) => {
                    row[header] = matches[i] || '';
                });
                row._rowNum = idx + 2;
                return row;
            });
        }

        function standardizeDate(dateStr) {
            if (!dateStr) return '';
            
            // Handle "Oct 8 2025" or "October 16 2025"
            const months = {
                'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04',
                'may': '05', 'jun': '06', 'jul': '07', 'aug': '08',
                'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12',
                'january': '01', 'february': '02', 'march': '03', 'april': '04',
                'june': '06', 'july': '07', 'august': '08', 'september': '09',
                'october': '10', 'november': '11', 'december': '12'
            };
            
            const textMatch = dateStr.toLowerCase().match(/([a-z]+)\s+(\d{1,2})\s+(\d{4})/);
            if (textMatch) {
                const month = months[textMatch[1]] || '01';
                const day = textMatch[2].padStart(2, '0');
                const year = textMatch[3];
                return `${month}/${day}/${year}`;
            }
            
            // Handle "10/1/2025"
            const slashMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (slashMatch) {
                const month = slashMatch[1].padStart(2, '0');
                const day = slashMatch[2].padStart(2, '0');
                return `${month}/${day}/${slashMatch[3]}`;
            }
            
            return dateStr;
        }

        function cleanAmount(amountStr) {
            if (!amountStr) return 0;
            const cleaned = amountStr.replace(/[$,]/g, '');
            return Math.ceil(parseFloat(cleaned));
        }

        function standardizeAccount(account) {
            if (!account) return 'Unclassified';
            
            const upper = account.toUpperCase().trim();
            
            if (upper.includes('SALES') || upper.includes('REVENUE')) {
                if (upper.includes('SERVICE')) return 'Service Revenue';
                if (upper.includes('SALES')) return 'Sales Revenue';
                return 'Revenue';
            }
            if (upper.includes('SUPPLIES') && upper.includes('EXPENSE')) return 'Supplies Expense';
            if (upper.includes('RENT')) return 'Rent Expense';
            if (upper.includes('UTILITIES')) return 'Utilities Expense';
            if (upper.includes('OWNER')) {
                if (upper.includes('INVESTMENT')) return 'Owner Investment';
                if (upper.includes('WITHDRAWAL')) return 'Owner Withdrawal';
            }
            
            // Proper case
            return account.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        function standardizePaymentMethod(method) {
            if (!method) return 'Unknown';
            
            const upper = method.toUpperCase().trim();
            
            // Proper case each word
            return method.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        function loadRawData() {
            rawData = parseCSV(rawCSV);
            const tbody = document.getElementById('rawTableBody');
            tbody.innerHTML = '';
            
            let duplicateCount = 0;
            const seenIDs = {};
            
            rawData.forEach((row, idx) => {
                const tr = document.createElement('tr');
                
                // Check for duplicates
                if (row['Transaction ID'] && seenIDs[row['Transaction ID']]) {
                    tr.className = 'duplicate';
                    duplicateCount++;
                }
                seenIDs[row['Transaction ID']] = true;
                
                tr.innerHTML = `
                    <td>${row['Transaction ID']}</td>
                    <td>${row['Date']}</td>
                    <td>${row['Description']}</td>
                    <td>${row['Amount']}</td>
                    <td>${row['Account Affected']}</td>
                    <td>${row['Payment Method']}</td>
                    <td>${row['Vendor/Customer']}</td>
                    <td>${row['Notes']}</td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('rawStatus').textContent = 
                `Loaded ${rawData.length} transactions (${duplicateCount} duplicates detected)`;
        }

        function applyCleaning() {
            cleanedData = [];
            formulas = {};
            
            const seen = {};
            let transIdCounter = 1;
            
            rawData.forEach((row, idx) => {
                const rowNum = row._rowNum;
                
                // Skip exact duplicates
                const key = `${row['Transaction ID']}-${row['Date']}-${row['Amount']}`;
                if (seen[key]) return;
                seen[key] = true;
                
                // Generate Trans ID if missing
                let transId = row['Transaction ID'];
                if (!transId) {
                    transId = `T${String(transIdCounter).padStart(3, '0')}`;
                    while (seen[`id-${transId}`]) {
                        transIdCounter++;
                        transId = `T${String(transIdCounter).padStart(3, '0')}`;
                    }
                }
                seen[`id-${transId}`] = true;
                transIdCounter++;
                
                const cleaned = {
                    _rowNum: rowNum,
                    _originalRow: idx,
                    TransID: transId,
                    Date: standardizeDate(row['Date']),
                    Description: row['Description'] || 'No description provided',
                    Amount: cleanAmount(row['Amount']),
                    Account: standardizeAccount(row['Account Affected']),
                    PaymentMethod: standardizePaymentMethod(row['Payment Method']),
                    VendorCustomer: row['Vendor/Customer'] || 'Unknown',
                    Notes: row['Notes'],
                    Flag: []
                };
                
                // Store formulas
                formulas[`A${rowNum}`] = {
                    formula: row['Transaction ID'] ? 
                        `=Raw_Data!A${rowNum}` : 
                        `="T"&TEXT(ROW()-1, "000")`,
                    explanation: row['Transaction ID'] ? 
                        `Copies original Transaction ID: ${row['Transaction ID']}` :
                        `Generates missing Transaction ID as <span class="cleaned-value">T${String(idx+1).padStart(3, '0')}</span> using ROW() function`,
                    original: row['Transaction ID'],
                    cleaned: cleaned.TransID
                };
                
                formulas[`B${rowNum}`] = {
                    formula: `=TEXT(DATEVALUE(Raw_Data!B${rowNum}), "MM/DD/YYYY")`,
                    explanation: `Converts <span class="original-value">"${row['Date']}"</span> to standardized format <span class="cleaned-value">"${cleaned.Date}"</span> using DATEVALUE and TEXT functions`,
                    original: row['Date'],
                    cleaned: cleaned.Date
                };
                
                formulas[`C${rowNum}`] = {
                    formula: row['Description'] ?
                        `=Raw_Data!C${rowNum}` :
                        `="No description provided"`,
                    explanation: row['Description'] ?
                        'Copies original description' :
                        'Fills missing description with default text',
                    original: row['Description'],
                    cleaned: cleaned.Description
                };
                
                formulas[`D${rowNum}`] = {
                    formula: `=ROUNDUP(VALUE(SUBSTITUTE(SUBSTITUTE(Raw_Data!D${rowNum}, "$", ""), ",", "")), 0)`,
                    explanation: `Removes $ and commas from <span class="original-value">"${row['Amount']}"</span>, then rounds up to <span class="cleaned-value">$${cleaned.Amount}</span> using ROUNDUP function`,
                    original: row['Amount'],
                    cleaned: cleaned.Amount
                };
                
                formulas[`E${rowNum}`] = {
                    formula: `=IF(ISNUMBER(SEARCH("SALES", UPPER(Raw_Data!E${rowNum}))), "Sales Revenue", IF(ISNUMBER(SEARCH("SERVICE", UPPER(Raw_Data!E${rowNum}))), "Service Revenue", PROPER(Raw_Data!E${rowNum})))`,
                    explanation: `Standardizes <span class="original-value">"${row['Account Affected']}"</span> to <span class="cleaned-value">"${cleaned.Account}"</span> using SEARCH and IF functions`,
                    original: row['Account Affected'],
                    cleaned: cleaned.Account
                };
                
                formulas[`F${rowNum}`] = {
                    formula: row['Payment Method'] ?
                        `=PROPER(Raw_Data!F${rowNum})` :
                        `="Unknown"`,
                    explanation: row['Payment Method'] ?
                        `Converts <span class="original-value">"${row['Payment Method']}"</span> to proper case: <span class="cleaned-value">"${cleaned.PaymentMethod}"</span>` :
                        'Fills missing payment method with "Unknown"',
                    original: row['Payment Method'],
                    cleaned: cleaned.PaymentMethod
                };
                
                formulas[`G${rowNum}`] = {
                    formula: row['Vendor/Customer'] ?
                        `=Raw_Data!G${rowNum}` :
                        `="Unknown"`,
                    explanation: row['Vendor/Customer'] ?
